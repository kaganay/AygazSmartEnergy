@using System.Linq
@model AygazSmartEnergy.Models.DeviceDetailsViewModel
@{
    ViewData["Title"] = "Cihaz DetayÄ±";
    var device = Model.Device;
    var latestConsumption = device.EnergyConsumptions.OrderByDescending(e => e.RecordedAt).FirstOrDefault();
    var latestSensor = device.SensorDatas?.OrderByDescending(s => s.RecordedAt).FirstOrDefault();
    var isOnline = latestSensor != null && latestSensor.RecordedAt >= DateTime.Now.AddMinutes(-10);

    // TÃ¼m tarihleri UTC'den TÃ¼rkiye saatine (Europe/Istanbul) Ã§evir
    Func<DateTime, DateTime> toTurkeyTime = utc =>
    {
        var tz = TimeZoneInfo.FindSystemTimeZoneById("Europe/Istanbul");
        if (utc.Kind == DateTimeKind.Unspecified)
        {
            utc = DateTime.SpecifyKind(utc, DateTimeKind.Utc);
        }
        else if (utc.Kind == DateTimeKind.Local)
        {
            utc = utc.ToUniversalTime();
        }
        return TimeZoneInfo.ConvertTimeFromUtc(utc, tz);
    };
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0"><i class="fas fa-microchip me-2"></i><span id="deviceNameHeader">@device.DeviceName</span></h2>
            <small class="text-muted">Seri No: @(string.IsNullOrWhiteSpace(device.SerialNumber) ? "TanÄ±msÄ±z" : device.SerialNumber)</small>
        </div>
        <div class="btn-group" role="group">
            <a asp-controller="Dashboard" asp-action="Devices" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i>Cihaz listesine dÃ¶n
            </a>
            <a asp-controller="Dashboard"
               asp-action="EnergyForecast"
               asp-route-deviceId="@device.Id"
               asp-route-daysAhead="7"
               class="btn btn-primary">
                <i class="fas fa-chart-line me-2"></i>AI Enerji Tahmini (7 GÃ¼n)
            </a>
        </div>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Durum</h6>
                    <div class="d-flex align-items-center flex-wrap">
                        <span class="badge @(device.IsActive ? "bg-success" : "bg-danger") me-2 mb-1">
                            @(device.IsActive ? "Aktif" : "Pasif")
                        </span>
                        <span class="badge @(isOnline ? "bg-success" : "bg-secondary") mb-1">
                            @(isOnline ? "Online" : "Offline")
                        </span>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Son Enerji KullanÄ±mÄ±</h6>
                    <div class="display-6 fw-bold" id="liveEnergy">
                        @(latestConsumption != null && latestConsumption.EnergyUsed > 0 ? latestConsumption.EnergyUsed.ToString("F2") : "-") <small class="text-muted fs-6">kWh</small>
                    </div>
                    <small class="text-muted" id="liveEnergyTime">
                        @(latestConsumption != null
                            ? toTurkeyTime(latestConsumption.RecordedAt).ToString("dd.MM.yyyy HH:mm:ss")
                            : "Veri yok")
                    </small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">AnlÄ±k SÄ±caklÄ±k</h6>
                    <div class="display-6 fw-bold" id="liveTemperature">
                        @(latestSensor != null && latestSensor.Temperature > 0 ? latestSensor.Temperature.ToString("F1") : "-") <small class="text-muted fs-6">Â°C</small>
                    </div>
                    <small class="text-muted" id="liveTemperatureTime">
                        @(latestSensor != null
                            ? toTurkeyTime(latestSensor.RecordedAt).ToString("dd.MM.yyyy HH:mm:ss")
                            : "Veri yok")
                    </small>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">AnlÄ±k Voltaj</h6>
                    <div class="display-6 fw-bold" id="liveVoltage">
                        @(latestSensor != null && latestSensor.Voltage > 0 ? latestSensor.Voltage.ToString("F2") : "-") <small class="text-muted fs-6">V</small>
                    </div>
                    <small class="text-muted" id="liveVoltageTime">@(latestSensor != null ? latestSensor.RecordedAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm:ss") : "Veri yok")</small>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <i class="fas fa-bolt me-2 text-warning"></i>Enerji TÃ¼ketimi (Son 30 kayÄ±t)
                </div>
                <div class="card-body">
                    @if (device.EnergyConsumptions.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped align-middle" id="energyConsumptionTable">
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Enerji (kWh)</th>
                                        <th>Maliyet (â‚º)</th>
                                        <th>Karbon (kg COâ‚‚)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in device.EnergyConsumptions.OrderByDescending(e => e.RecordedAt).Take(30))
                                    {
                                        <tr>
                                            <td>@toTurkeyTime(item.RecordedAt).ToString("dd.MM.yyyy HH:mm:ss")</td>
                                            <td>@item.EnergyUsed.ToString("F2")</td>
                                            <td>@item.CostPerHour.ToString("F2")</td>
                                            <td>@item.CarbonFootprint.ToString("F3")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>Bu cihaz iÃ§in henÃ¼z enerji verisi bulunmuyor.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <i class="fas fa-wave-square me-2 text-info"></i>SensÃ¶r Verileri
                </div>
                <div class="card-body">
                    @if (device.SensorDatas != null && device.SensorDatas.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped align-middle" id="sensorDataTable">
                                <thead>
                                    <tr>
                                        <th>Zaman</th>
                                        <th>SÄ±caklÄ±k (Â°C)</th>
                                        <th>Voltaj (V)</th>
                                        <th>AkÄ±m (A)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var sensor in device.SensorDatas.OrderByDescending(s => s.RecordedAt).Take(30))
                                    {
                                        <tr>
                                            <td>@toTurkeyTime(sensor.RecordedAt).ToString("dd.MM.yyyy HH:mm:ss")</td>
                                        <td>@(sensor.Temperature > 0 ? sensor.Temperature.ToString("F1") : "-")</td>
                                        <td>@(sensor.Voltage > 0 ? sensor.Voltage.ToString("F2") : "-")</td>
                                        <td>@(sensor.Current > 0 ? sensor.Current.ToString("F2") : "-")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>Bu cihaz iÃ§in sensÃ¶r verisi bulunmuyor.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/lib/signalr/dist/browser/signalr.min.js"></script>
    <script>
        // ðŸ”¹ SignalR BaÄŸlantÄ±sÄ±: Cihaz detay sayfasÄ± iÃ§in anlÄ±k gÃ¼ncelleme
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/energyHub")
            .build();

        // ðŸ”¹ DOM ReferanslarÄ±: GÃ¼ncellenecek elementler
        const deviceId = @device.Id;
        const lastEnergyEl = document.getElementById('liveEnergy');
        const lastEnergyTimeEl = document.getElementById('liveEnergyTime');
        const lastTempEl = document.getElementById('liveTemperature');
        const lastTempTimeEl = document.getElementById('liveTemperatureTime');
        const lastVoltageEl = document.getElementById('liveVoltage');
        const lastVoltageTimeEl = document.getElementById('liveVoltageTime');

        // ðŸ”¹ SensÃ¶r Verisi GÃ¼ncellemesi: Yeni sensÃ¶r verisi geldiÄŸinde
        connection.on("ReceiveSensorData", (sensorData) => {
            if (!sensorData) return;
            
            // DeviceId kontrolÃ¼: EÄŸer DeviceId varsa ve bu cihazÄ±n ID'si deÄŸilse iÅŸleme alma
            const dataDeviceId = sensorData.DeviceId || sensorData.deviceId;
            if (dataDeviceId && dataDeviceId !== deviceId) {
                return; // Bu cihaza ait deÄŸil, iÅŸleme alma
            }
            
            console.log("ReceiveSensorData event received:", sensorData);

            // Cihaz adÄ±nÄ± gÃ¼ncelle (eÄŸer gelirse)
            const deviceName = sensorData.DeviceName || sensorData.deviceName;
            if (deviceName && document.getElementById('deviceNameHeader')) {
                document.getElementById('deviceNameHeader').textContent = deviceName;
            }

            // SÄ±caklÄ±k gÃ¼ncelle - TÃ¼m deÄŸerleri kabul et (0 dahil, sadece null/undefined kontrolÃ¼)
            const temperature = sensorData.Temperature !== undefined ? sensorData.Temperature : 
                                sensorData.temperature !== undefined ? sensorData.temperature : null;
            if (temperature !== undefined && temperature !== null && !isNaN(temperature) && lastTempEl) {
                lastTempEl.innerHTML = parseFloat(temperature).toFixed(1) + ' <small class="text-muted fs-6">Â°C</small>';
                if (lastTempTimeEl) {
                    // RecordedAt varsa onu kullan, yoksa ÅŸu anki zamanÄ± kullan
                    const recordedAt = sensorData.RecordedAt || sensorData.recordedAt;
                    let timeToShow;
                    if (recordedAt) {
                        // SignalR'dan gelen tarih ISO 8601 formatÄ±nda UTC olarak gelir: "2025-12-03T00:02:36.000Z"
                        // JavaScript new Date() bu string'i parse ettiÄŸinde UTC olarak yorumlar ve Date objesi oluÅŸturur
                        // Date objesi her zaman UTC timestamp'i iÃ§erir, ama toString() local timezone'a gÃ¶re gÃ¶sterir
                        // toLocaleString() ile timeZone belirtildiÄŸinde, Date objesi UTC olarak yorumlanÄ±p belirtilen timezone'a Ã§evrilir
                        const dateStr = String(recordedAt);
                        // EÄŸer Z ile bitmiyorsa (UTC iÅŸareti yoksa), UTC olarak iÅŸaretle
                        const utcStr = dateStr.endsWith('Z') ? dateStr : (dateStr + 'Z');
                        // UTC string'ini parse et (Date objesi UTC timestamp'i iÃ§erir)
                        timeToShow = new Date(utcStr);
                    } else {
                        timeToShow = new Date();
                    }
                    // UTC Date objesini Istanbul timezone'Ä±na Ã§evir (toLocaleString timeZone ile doÄŸru Ã§evirir)
                    lastTempTimeEl.textContent = timeToShow.toLocaleString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZone: 'Europe/Istanbul' // UTC'den Istanbul'a Ã§evir (UTC+3)
                    });
                }
                console.log("Temperature updated:", temperature, "at", sensorData.RecordedAt);
            }

            // Voltaj gÃ¼ncelle - TÃ¼m deÄŸerleri kabul et (0 dahil, sadece null/undefined kontrolÃ¼)
            const voltage = sensorData.Voltage !== undefined ? sensorData.Voltage : 
                           sensorData.voltage !== undefined ? sensorData.voltage : null;
            if (voltage !== undefined && voltage !== null && !isNaN(voltage) && lastVoltageEl) {
                lastVoltageEl.innerHTML = parseFloat(voltage).toFixed(2) + ' <small class="text-muted fs-6">V</small>';
                if (lastVoltageTimeEl) {
                    // RecordedAt varsa onu kullan, yoksa ÅŸu anki zamanÄ± kullan
                    const recordedAt = sensorData.RecordedAt || sensorData.recordedAt;
                    let timeToShow;
                    if (recordedAt) {
                        // UTC string'ini doÄŸru parse et
                        const dateStr = String(recordedAt);
                        const utcStr = dateStr.endsWith('Z') ? dateStr : (dateStr + 'Z');
                        timeToShow = new Date(utcStr);
                    } else {
                        timeToShow = new Date();
                    }
                    // UTC tarihini Istanbul timezone'Ä±na Ã§evir
                    lastVoltageTimeEl.textContent = timeToShow.toLocaleString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZone: 'Europe/Istanbul'
                    });
                }
                console.log("Voltage updated:", voltage, "at", sensorData.RecordedAt);
            }

            // SensÃ¶r verileri tablosuna yeni satÄ±r ekle
            addSensorDataToTable(sensorData);
        });

        // ðŸ”¹ Enerji TÃ¼ketimi GÃ¼ncellemesi: Yeni enerji tÃ¼ketimi verisi geldiÄŸinde
        connection.on("ReceiveEnergyConsumption", (consumption) => {
            if (!consumption) return;
            
            // DeviceId kontrolÃ¼: EÄŸer DeviceId varsa ve bu cihazÄ±n ID'si deÄŸilse iÅŸleme alma
            const dataDeviceId = consumption.DeviceId || consumption.deviceId;
            if (dataDeviceId && dataDeviceId !== deviceId) {
                return; // Bu cihaza ait deÄŸil, iÅŸleme alma
            }
            
            console.log("ReceiveEnergyConsumption event received:", consumption);

            // Enerji kullanÄ±mÄ± gÃ¼ncelle - TÃ¼m deÄŸerleri kabul et (0 dahil, sadece null/undefined kontrolÃ¼)
            const energyUsed = consumption.EnergyUsed !== undefined ? consumption.EnergyUsed : 
                              consumption.energyUsed !== undefined ? consumption.energyUsed : null;
            if (energyUsed !== undefined && energyUsed !== null && !isNaN(energyUsed) && lastEnergyEl) {
                lastEnergyEl.innerHTML = parseFloat(energyUsed).toFixed(2) + ' <small class="text-muted fs-6">kWh</small>';
                if (lastEnergyTimeEl) {
                    // RecordedAt varsa onu kullan, yoksa ÅŸu anki zamanÄ± kullan
                    const recordedAt = consumption.RecordedAt || consumption.recordedAt;
                    let timeToShow;
                    if (recordedAt) {
                        // UTC string'ini doÄŸru parse et
                        const dateStr = String(recordedAt);
                        const utcStr = dateStr.endsWith('Z') ? dateStr : (dateStr + 'Z');
                        timeToShow = new Date(utcStr);
                    } else {
                        timeToShow = new Date();
                    }
                    // UTC tarihini Istanbul timezone'Ä±na Ã§evir
                    lastEnergyTimeEl.textContent = timeToShow.toLocaleString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        timeZone: 'Europe/Istanbul'
                    });
                }
                console.log("Energy updated:", energyUsed, "at", consumption.RecordedAt);
            }

            // Enerji tÃ¼ketimi tablosuna yeni satÄ±r ekle
            addEnergyConsumptionToTable(consumption);
        });

        // ðŸ”¹ BaÄŸlantÄ± BaÅŸlatma
        connection.start().then(function () {
            console.log("SignalR connected for device:", deviceId);
            // Cihaz grubuna katÄ±l - bu cihaza Ã¶zel gÃ¼ncellemeleri almak iÃ§in
            if (deviceId) {
                connection.invoke("JoinDeviceGroup", deviceId).then(function () {
                    console.log("Joined device group:", deviceId);
                }).catch(function (err) {
                    console.error("Error joining device group:", err);
                });
            }
        }).catch(function (err) {
            console.error("SignalR connection error:", err);
        });

        // ðŸ”¹ SensÃ¶r Verileri Tablosuna Yeni SatÄ±r Ekleme
        function addSensorDataToTable(sensorData) {
            // SensÃ¶r verileri tablosunu ID ile bul
            const sensorTable = document.querySelector('#sensorDataTable tbody');
            if (!sensorTable) {
                console.warn("Sensor table not found - ID: sensorDataTable");
                return;
            }

            // RecordedAt varsa onu kullan, yoksa ÅŸu anki zamanÄ± kullan
            const recordedAt = sensorData.RecordedAt || sensorData.recordedAt;
            let timeToShow;
            if (recordedAt) {
                // UTC string'ini doÄŸru parse et
                const dateStr = String(recordedAt);
                const utcStr = dateStr.endsWith('Z') ? dateStr : (dateStr + 'Z');
                timeToShow = new Date(utcStr);
            } else {
                timeToShow = new Date();
            }
            // UTC tarihini Istanbul timezone'Ä±na Ã§evir
            const timeStr = timeToShow.toLocaleString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Europe/Istanbul'
            });

            // Verileri gÃ¼venli ÅŸekilde al (bÃ¼yÃ¼k/kÃ¼Ã§Ã¼k harf uyumu)
            const temperature = sensorData.Temperature !== undefined ? sensorData.Temperature : 
                                sensorData.temperature !== undefined ? sensorData.temperature : null;
            const voltage = sensorData.Voltage !== undefined ? sensorData.Voltage : 
                           sensorData.voltage !== undefined ? sensorData.voltage : null;
            const current = sensorData.Current !== undefined ? sensorData.Current : 
                           sensorData.current !== undefined ? sensorData.current : null;

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${timeStr}</td>
                <td>${temperature !== null && temperature !== undefined && !isNaN(temperature) ? parseFloat(temperature).toFixed(1) : '-'}</td>
                <td>${voltage !== null && voltage !== undefined && !isNaN(voltage) ? parseFloat(voltage).toFixed(2) : '-'}</td>
                <td>${current !== null && current !== undefined && !isNaN(current) ? parseFloat(current).toFixed(2) : '-'}</td>
            `;

            // En Ã¼ste ekle
            sensorTable.insertBefore(newRow, sensorTable.firstChild);

            // Maksimum 30 satÄ±r tut (eski satÄ±rlarÄ± sil)
            while (sensorTable.children.length > 30) {
                sensorTable.removeChild(sensorTable.lastChild);
            }
        }

        // ðŸ”¹ Enerji TÃ¼ketimi Tablosuna Yeni SatÄ±r Ekleme
        function addEnergyConsumptionToTable(consumption) {
            // Enerji tÃ¼ketimi tablosunu ID ile bul
            const energyTable = document.querySelector('#energyConsumptionTable tbody');
            if (!energyTable) {
                console.warn("Energy consumption table not found - ID: energyConsumptionTable");
                return;
            }

            // RecordedAt varsa onu kullan, yoksa ÅŸu anki zamanÄ± kullan
            const recordedAt = consumption.RecordedAt || consumption.recordedAt;
            let timeToShow;
            if (recordedAt) {
                // UTC string'ini doÄŸru parse et
                const dateStr = String(recordedAt);
                const utcStr = dateStr.endsWith('Z') ? dateStr : (dateStr + 'Z');
                timeToShow = new Date(utcStr);
            } else {
                timeToShow = new Date();
            }
            // UTC tarihini Istanbul timezone'Ä±na Ã§evir
            const timeStr = timeToShow.toLocaleString('tr-TR', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZone: 'Europe/Istanbul'
            });

            // Hesaplamalar: EnergyUsed varsa CostPerHour ve CarbonFootprint hesapla
            const energyUsed = consumption.EnergyUsed || consumption.energyUsed || 0;
            const costPerHour = consumption.CostPerHour || consumption.costPerHour || (energyUsed * 0.5); // 0.5 TL per kWh
            const carbonFootprint = consumption.CarbonFootprint || consumption.carbonFootprint || (energyUsed * 0.4); // 0.4 kg CO2 per kWh

            const newRow = document.createElement('tr');
            newRow.innerHTML = `
                <td>${timeStr}</td>
                <td>${energyUsed > 0 ? energyUsed.toFixed(2) : '-'}</td>
                <td>${energyUsed > 0 ? costPerHour.toFixed(2) : '-'}</td>
                <td>${energyUsed > 0 ? carbonFootprint.toFixed(3) : '-'}</td>
            `;

            // En Ã¼ste ekle
            energyTable.insertBefore(newRow, energyTable.firstChild);

            // Maksimum 30 satÄ±r tut (eski satÄ±rlarÄ± sil)
            while (energyTable.children.length > 30) {
                energyTable.removeChild(energyTable.lastChild);
            }
        }
    </script>
}
