@{
    ViewData["Title"] = "UyarÄ±lar";
}

@model List<AygazSmartEnergy.Models.Alert>

<div class="container-fluid">
    <h1 class="mt-4">UyarÄ± YÃ¶netimi</h1>
    <nav aria-label="breadcrumb" class="mb-4">
        <div class="btn-group" role="group" aria-label="Breadcrumb">
            <a class="btn btn-outline-primary" asp-controller="Dashboard" asp-action="Index">
                <i class="fas fa-home me-2"></i>Dashboard
            </a>
            <span class="btn btn-primary active" aria-current="page">
                <i class="fas fa-bell me-2"></i>UyarÄ±lar
            </span>
        </div>
    </nav>

    <!-- Filtreler -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-filter me-1"></i>
            Filtreler
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-3">
                    <label for="severityFilter" class="form-label">Åžiddet</label>
                    <select class="form-select" id="severityFilter">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="Critical">Kritik</option>
                        <option value="High">YÃ¼ksek</option>
                        <option value="Medium">Orta</option>
                        <option value="Low">DÃ¼ÅŸÃ¼k</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="statusFilter" class="form-label">Durum</label>
                    <select class="form-select" id="statusFilter">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="open">AÃ§Ä±k</option>
                        <option value="resolved">Ã‡Ã¶zÃ¼ldÃ¼</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="typeFilter" class="form-label">Tip</label>
                    <select class="form-select" id="typeFilter">
                        <option value="">TÃ¼mÃ¼</option>
                        <option value="HighConsumption">YÃ¼ksek TÃ¼ketim</option>
                        <option value="DeviceOffline">Cihaz Ã‡evrimdÄ±ÅŸÄ±</option>
                        <option value="TemperatureAnomaly">SÄ±caklÄ±k Anomalisi</option>
                        <option value="VoltageAnomaly">Voltaj Anomalisi</option>
                        <option value="LowPowerFactor">DÃ¼ÅŸÃ¼k GÃ¼Ã§ FaktÃ¶rÃ¼</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button class="btn btn-primary" onclick="applyFilters()">
                            <i class="fas fa-search"></i> Filtrele
                        </button>
                        <button class="btn btn-secondary" onclick="clearFilters()">
                            <i class="fas fa-times"></i> Temizle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UyarÄ± Listesi -->
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-bell me-1"></i>
            UyarÄ± Listesi
            <div class="float-end">
                <button class="btn btn-success btn-sm" onclick="markAllAsRead()">
                    <i class="fas fa-check"></i> TÃ¼mÃ¼nÃ¼ Okundu Ä°ÅŸaretle
                </button>
            </div>
        </div>
        <div class="card-body">
            @if (Model.Any())
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="alertsTable" width="100%" cellspacing="0">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 40px;">
                                    <input type="checkbox" id="selectAll" onchange="toggleSelectAll()" title="TÃ¼mÃ¼nÃ¼ SeÃ§">
                                </th>
                                <th style="width: 150px;">BaÅŸlÄ±k</th>
                                <th style="width: 250px;">Mesaj</th>
                                <th style="width: 150px;">Cihaz</th>
                                <th style="width: 120px;">Tip</th>
                                <th style="width: 100px;">Åžiddet</th>
                                <th style="width: 150px;">Tarih/Saat</th>
                                <th style="width: 100px;">Durum</th>
                                <th style="width: 120px;" class="text-center">Ä°ÅŸlemler</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var alert in Model)
                            {
                                <tr class="@(alert.IsResolved ? "" : "table-warning")" data-alert-id="@alert.Id">
                                    <td class="text-center">
                                        <input type="checkbox" class="alert-checkbox" value="@alert.Id">
                                    </td>
                                    <td>
                                        <strong class="text-primary">@alert.Title</strong>
                                    </td>
                                    <td>
                                        <div class="text-truncate" style="max-width: 250px;" title="@alert.Message">
                                            @(alert.Message?.Length > 50 ? alert.Message.Substring(0, 50) + "..." : alert.Message ?? "-")
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge bg-info">@(alert.Device?.DeviceName ?? "Genel")</span>
                                    </td>
                                    <td>
                                        <small class="text-muted">@alert.AlertType</small>
                                    </td>
                                    <td>
                                        <span class="badge @(alert.Severity switch {
                                            "Critical" => "bg-danger",
                                            "High" => "bg-warning text-dark",
                                            "Medium" => "bg-info",
                                            "Low" => "bg-secondary",
                                            _ => "bg-secondary"
                                        })" style="font-size: 0.85em;">
                                            @(alert.Severity switch {
                                                "Critical" => "Kritik",
                                                "High" => "YÃ¼ksek",
                                                "Medium" => "Orta",
                                                "Low" => "DÃ¼ÅŸÃ¼k",
                                                _ => alert.Severity
                                            })
                                        </span>
                                    </td>
                                    <td>
                                        @{
                                            var tz = TimeZoneInfo.FindSystemTimeZoneById("Europe/Istanbul");
                                            var createdUtc = DateTime.SpecifyKind(alert.CreatedAt, DateTimeKind.Utc);
                                            var createdTr = TimeZoneInfo.ConvertTimeFromUtc(createdUtc, tz);
                                        }
                                        <small>
                                            <i class="fas fa-calendar-alt text-muted"></i>
                                            @createdTr.ToString("dd.MM.yyyy")
                                            <br>
                                            <i class="fas fa-clock text-muted"></i>
                                            @createdTr.ToString("HH:mm:ss")
                                        </small>
                                    </td>
                                    <td>
                                        <span class="badge @(alert.IsResolved ? "bg-success" : "bg-warning text-dark")">
                                            @if (alert.IsResolved)
                                            {
                                                <i class="fas fa-check-circle"></i> <text>Ã‡Ã¶zÃ¼ldÃ¼</text>
                                            }
                                            else
                                            {
                                                <i class="fas fa-exclamation-circle"></i> <text>AÃ§Ä±k</text>
                                            }
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <div class="btn-group btn-group-sm" role="group">
                                            @if (!alert.IsResolved)
                                            {
                                                <button class="btn btn-success" onclick="resolveAlert(@alert.Id)" title="UyarÄ±yÄ± Ã‡Ã¶z">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                            }
                                            <button class="btn btn-danger" onclick="deleteAlert(@alert.Id)" title="UyarÄ±yÄ± Sil">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
            else
            {
                <div class="text-center text-muted">
                    <i class="fas fa-bell-slash fa-3x mb-3"></i>
                    <p>HenÃ¼z uyarÄ± bulunmuyor.</p>
                </div>
            }
        </div>
    </div>
</div>

<!-- UyarÄ± Ã‡Ã¶zme Modal -->
<div class="modal fade" id="resolveAlertModal" tabindex="-1" aria-labelledby="resolveAlertModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="resolveAlertModalLabel">
                    <i class="fas fa-check-circle me-2"></i>UyarÄ±yÄ± Ã‡Ã¶z
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="resolveAlertForm">
                <div class="modal-body">
                    <input type="hidden" id="alertId" name="alertId">
                    
                    <!-- ML Tavsiyeleri BÃ¶lÃ¼mÃ¼ -->
                    <div class="card border-primary mb-3" id="recommendationsCard">
                        <div class="card-header bg-primary text-white">
                            <i class="fas fa-brain me-2"></i>
                            <strong>ðŸ¤– AI/ML Tavsiyeleri</strong>
                            <span class="badge bg-light text-primary ms-2" id="alertTypeBadge"></span>
                        </div>
                        <div class="card-body">
                            <div id="recommendationsLoading" class="text-center py-3">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">YÃ¼kleniyor...</span>
                                </div>
                                <p class="mt-2 text-muted">Tavsiyeler yÃ¼kleniyor...</p>
                            </div>
                            <div id="recommendationsList" style="display: none;">
                                <p class="text-muted small mb-2">
                                    <i class="fas fa-info-circle me-1"></i>
                                    AÅŸaÄŸÄ±daki tavsiyeler ML servisi tarafÄ±ndan uyarÄ± tipine gÃ¶re Ã¶nerilmiÅŸtir:
                                </p>
                                <ul class="list-group list-group-flush" id="recommendationsItems">
                                    <!-- Tavsiyeler buraya eklenecek -->
                                </ul>
                            </div>
                            <div id="recommendationsError" class="alert alert-warning" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Tavsiyeler yÃ¼klenirken bir hata oluÅŸtu. Genel kontrol yapmanÄ±z Ã¶nerilir.
                            </div>
                        </div>
                    </div>
                    
                    <!-- AlÄ±nan Aksiyon BÃ¶lÃ¼mÃ¼ -->
                    <div class="mb-3">
                        <label for="actionTaken" class="form-label">
                            <i class="fas fa-clipboard-check me-2"></i>AlÄ±nan Aksiyon
                        </label>
                        <textarea class="form-control" id="actionTaken" name="actionTaken" rows="4" required 
                                  placeholder="UyarÄ±yÄ± Ã§Ã¶zmek iÃ§in ne yaptÄ±ÄŸÄ±nÄ±zÄ± detaylÄ± olarak aÃ§Ä±klayÄ±n..."></textarea>
                        <small class="form-text text-muted">
                            YukarÄ±daki tavsiyelerden hangilerini uyguladÄ±ÄŸÄ±nÄ±zÄ± belirtin.
                        </small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Ä°ptal
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check me-2"></i>UyarÄ±yÄ± Ã‡Ã¶z
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // UyarÄ± Ã§Ã¶zme
        function resolveAlert(alertId) {
            document.getElementById('alertId').value = alertId;
            document.getElementById('actionTaken').value = '';
            
            // Modal'Ä± gÃ¶ster
            const modal = new bootstrap.Modal(document.getElementById('resolveAlertModal'));
            modal.show();
            
            // Tavsiyeleri yÃ¼kle
            loadRecommendations(alertId);
        }
        
        // ML tavsiyelerini yÃ¼kle
        function loadRecommendations(alertId) {
            // Loading gÃ¶ster
            document.getElementById('recommendationsLoading').style.display = 'block';
            document.getElementById('recommendationsList').style.display = 'none';
            document.getElementById('recommendationsError').style.display = 'none';
            document.getElementById('recommendationsItems').innerHTML = '';
            
            fetch(`/Dashboard/GetAlertRecommendations?alertId=${alertId}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('recommendationsLoading').style.display = 'none';
                    
                    if (data.success && data.recommendations && data.recommendations.length > 0) {
                        // Alert tipi badge'i gÃ¼ncelle
                        if (data.alertType) {
                            document.getElementById('alertTypeBadge').textContent = data.alertType;
                        }
                        
                        // Tavsiyeleri gÃ¶ster
                        const recommendationsList = document.getElementById('recommendationsItems');
                        data.recommendations.forEach((rec, index) => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-primary me-2 mt-1">${index + 1}</span>
                                    <div class="flex-grow-1">
                                        <span class="small">${rec}</span>
                                    </div>
                                </div>
                            `;
                            recommendationsList.appendChild(li);
                        });
                        
                        document.getElementById('recommendationsList').style.display = 'block';
                    } else {
                        // Fallback tavsiyeler
                        const recommendationsList = document.getElementById('recommendationsItems');
                        const fallbackRecs = [
                            'ðŸ” Genel sistem kontrolÃ¼ yapÄ±n',
                            'ðŸ“Š UyarÄ± kaynaÄŸÄ±nÄ± belirleyin',
                            'âš™ï¸ Ä°lgili cihazlarÄ± kontrol edin'
                        ];
                        
                        fallbackRecs.forEach((rec, index) => {
                            const li = document.createElement('li');
                            li.className = 'list-group-item';
                            li.innerHTML = `
                                <div class="d-flex align-items-start">
                                    <span class="badge bg-secondary me-2 mt-1">${index + 1}</span>
                                    <div class="flex-grow-1">
                                        <span class="small">${rec}</span>
                                    </div>
                                </div>
                            `;
                            recommendationsList.appendChild(li);
                        });
                        
                        document.getElementById('recommendationsList').style.display = 'block';
                    }
                })
                .catch(error => {
                    console.error('Error loading recommendations:', error);
                    document.getElementById('recommendationsLoading').style.display = 'none';
                    document.getElementById('recommendationsError').style.display = 'block';
                });
        }

        // UyarÄ± silme
        function deleteAlert(alertId) {
            if (confirm('Bu uyarÄ±yÄ± silmek istediÄŸinizden emin misiniz?')) {
                fetch(`/Dashboard/DeleteAlert/${alertId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Hata: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Bir hata oluÅŸtu');
                });
            }
        }

        // UyarÄ± Ã§Ã¶zme formu
        document.getElementById('resolveAlertForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const alertId = document.getElementById('alertId').value;
            const actionTaken = document.getElementById('actionTaken').value;
            
            if (!actionTaken || actionTaken.trim() === '') {
                alert('LÃ¼tfen alÄ±nan aksiyonu aÃ§Ä±klayÄ±n');
                return;
            }

            // Submit butonunu devre dÄ±ÅŸÄ± bÄ±rak
            const submitBtn = this.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Ä°ÅŸleniyor...';

            fetch(`/Dashboard/ResolveAlert`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: parseInt(alertId),
                    actionTaken: actionTaken
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    // Modal'Ä± kapat
                    const modal = bootstrap.Modal.getInstance(document.getElementById('resolveAlertModal'));
                    if (modal) {
                        modal.hide();
                    }
                    // SayfayÄ± yenile
                    location.reload();
                } else {
                    alert('Hata: ' + (data.message || 'UyarÄ± Ã§Ã¶zÃ¼lÃ¼rken bir hata oluÅŸtu'));
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Bir hata oluÅŸtu: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            });
        });

        // TÃ¼mÃ¼nÃ¼ seÃ§/seÃ§me
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.alert-checkbox');
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
            });
        }

        // TÃ¼mÃ¼nÃ¼ okundu iÅŸaretle
        function markAllAsRead() {
            const checkedBoxes = document.querySelectorAll('.alert-checkbox:checked');
            const alertIds = Array.from(checkedBoxes).map(cb => cb.value);
            
            if (alertIds.length === 0) {
                alert('LÃ¼tfen en az bir uyarÄ± seÃ§in');
                return;
            }

            if (confirm(`${alertIds.length} uyarÄ±yÄ± okundu olarak iÅŸaretlemek istediÄŸinizden emin misiniz?`)) {
                fetch('/Dashboard/MarkAllAsRead', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ alertIds: alertIds })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Hata: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Bir hata oluÅŸtu');
                });
            }
        }

        // Filtreleri uygula
        function applyFilters() {
            const severity = document.getElementById('severityFilter').value;
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            
            // URL parametrelerini oluÅŸtur
            const params = new URLSearchParams();
            if (severity) params.append('severity', severity);
            if (status) params.append('status', status);
            if (type) params.append('type', type);
            
            // SayfayÄ± yenile
            window.location.href = window.location.pathname + '?' + params.toString();
        }

        // Filtreleri temizle
        function clearFilters() {
            document.getElementById('severityFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('typeFilter').value = '';
            window.location.href = window.location.pathname;
        }

        // SignalR baÄŸlantÄ±sÄ± - canlÄ± uyarÄ± gÃ¼ncellemeleri iÃ§in
        let connection = null;
        if (typeof signalR !== 'undefined') {
            connection = new signalR.HubConnectionBuilder()
                .withUrl("/energyHub")
                .withAutomaticReconnect() // Otomatik yeniden baÄŸlanma
                .build();

            // Yeni uyarÄ± bildirimi - baÄŸlantÄ± kurulmadan Ã¶nce tanÄ±mla
            connection.on("ReceiveAlert", (alert) => {
                if (!alert) {
                    console.warn("BoÅŸ alert alÄ±ndÄ±");
                    return;
                }
                console.log("Yeni uyarÄ± alÄ±ndÄ±:", alert);
                
                // Toast bildirimi gÃ¶ster
                showAlertNotification(alert);
                
                // UyarÄ± tablosuna ekle
                addAlertToTable(alert);
                
                // UyarÄ± sayÄ±sÄ±nÄ± gÃ¼ncelle (eÄŸer fonksiyon varsa)
                if (typeof updateUnresolvedCount === 'function') {
                    updateUnresolvedCount();
                }
            });

        // UyarÄ± gÃ¼ncelleme bildirimi
        connection.on("ReceiveAlertUpdate", (alertUpdate) => {
            if (!alertUpdate) return;
            console.log("UyarÄ± gÃ¼ncellendi:", alertUpdate);
            
            // UyarÄ± tablosundaki ilgili satÄ±rÄ± gÃ¼ncelle
            if (typeof updateAlertInTable === 'function') {
                updateAlertInTable(alertUpdate);
            }
        });

            // BaÄŸlantÄ± baÅŸlat
            connection.start().then(function () {
                console.log("âœ“ SignalR baÄŸlantÄ±sÄ± kuruldu - Alert sayfasÄ±");
            }).catch(function (err) {
                console.error("âœ— SignalR baÄŸlantÄ± hatasÄ±:", err);
            });
        } else {
            console.warn("âš  SignalR yÃ¼klenmedi. CanlÄ± gÃ¼ncellemeler Ã§alÄ±ÅŸmayacak.");
        }

        // YardÄ±mcÄ± fonksiyonlar
        function showAlertNotification(alert) {
            const severity = alert.severity || alert.Severity || 'Medium';
            const bgColor = severity === 'Critical' ? 'danger' : 
                           severity === 'High' ? 'warning' : 
                           severity === 'Medium' ? 'info' : 'secondary';
            
            // Toast bildirimi oluÅŸtur (Bootstrap 5)
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${bgColor} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${alert.title || alert.Title}</strong><br>
                        ${alert.message || alert.Message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
            bsToast.show();
            
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function addAlertToTable(alert) {
            const tableBody = document.querySelector('#alertsTable tbody');
            if (!tableBody) {
                // EÄŸer tablo yoksa, sayfayÄ± yenile
                console.log("Tablo bulunamadÄ±, sayfa yenileniyor...");
                setTimeout(() => location.reload(), 1000);
                return;
            }
            
            const severity = alert.severity || alert.Severity || 'Medium';
            const severityClass = severity === 'Critical' ? 'bg-danger' : 
                                 severity === 'High' ? 'bg-warning text-dark' : 
                                 severity === 'Medium' ? 'bg-info' : 'bg-secondary';
            
            const alertId = alert.id || alert.Id;
            const alertTitle = alert.title || alert.Title || 'BaÅŸlÄ±ksÄ±z UyarÄ±';
            const alertMessage = alert.message || alert.Message || '';
            const alertType = alert.alertType || alert.AlertType || '';
            const deviceName = alert.deviceName || alert.DeviceName || 'Bilinmeyen Cihaz';
            const isResolved = alert.isResolved || alert.IsResolved || false;
            const createdAt = alert.createdAt || alert.CreatedAt;
            
            // Tarih formatÄ±nÄ± parse et
            let formattedDate = '';
            let formattedTime = '';
            if (createdAt) {
                try {
                    const date = new Date(createdAt);
                    formattedDate = date.toLocaleDateString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                    formattedTime = date.toLocaleTimeString('tr-TR', {
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit'
                    });
                } catch (e) {
                    console.error("Tarih parse hatasÄ±:", e);
                    formattedDate = new Date().toLocaleDateString('tr-TR');
                    formattedTime = new Date().toLocaleTimeString('tr-TR');
                }
            } else {
                const now = new Date();
                formattedDate = now.toLocaleDateString('tr-TR');
                formattedTime = now.toLocaleTimeString('tr-TR');
            }
            
            // Åžiddet TÃ¼rkÃ§e Ã§evirisi
            const severityText = severity === 'Critical' ? 'Kritik' : 
                                severity === 'High' ? 'YÃ¼ksek' : 
                                severity === 'Medium' ? 'Orta' : 
                                severity === 'Low' ? 'DÃ¼ÅŸÃ¼k' : severity;
            
            // Mesaj kÄ±saltma
            const shortMessage = alertMessage.length > 50 ? alertMessage.substring(0, 50) + '...' : alertMessage;
            
            const row = document.createElement('tr');
            row.setAttribute('data-alert-id', alertId);
            if (!isResolved) {
                row.classList.add('table-warning');
            }
            
            row.innerHTML = `
                <td class="text-center">
                    <input type="checkbox" class="alert-checkbox" value="${alertId}">
                </td>
                <td>
                    <strong class="text-primary">${alertTitle}</strong>
                </td>
                <td>
                    <div class="text-truncate" style="max-width: 250px;" title="${alertMessage}">
                        ${shortMessage}
                    </div>
                </td>
                <td>
                    <span class="badge bg-info">${deviceName}</span>
                </td>
                <td>
                    <small class="text-muted">${alertType}</small>
                </td>
                <td>
                    <span class="badge ${severityClass}" style="font-size: 0.85em;">${severityText}</span>
                </td>
                <td>
                    <small>
                        <i class="fas fa-calendar-alt text-muted"></i> ${formattedDate}
                        ${formattedTime ? `<br><i class="fas fa-clock text-muted"></i> ${formattedTime}` : ''}
                    </small>
                </td>
                <td>
                    <span class="badge ${isResolved ? 'bg-success' : 'bg-warning text-dark'}">
                        ${isResolved ? '<i class="fas fa-check-circle"></i> Ã‡Ã¶zÃ¼ldÃ¼' : '<i class="fas fa-exclamation-circle"></i> AÃ§Ä±k'}
                    </span>
                </td>
                <td class="text-center">
                    <div class="btn-group btn-group-sm" role="group">
                        ${!isResolved ? `
                            <button class="btn btn-success" onclick="resolveAlert(${alertId})" title="UyarÄ±yÄ± Ã‡Ã¶z">
                                <i class="fas fa-check"></i>
                            </button>
                        ` : ''}
                        <button class="btn btn-danger" onclick="deleteAlert(${alertId})" title="UyarÄ±yÄ± Sil">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            // En Ã¼ste ekle
            tableBody.insertBefore(row, tableBody.firstChild);
            
            // EÄŸer tablo boÅŸsa, "HenÃ¼z uyarÄ± bulunmuyor" mesajÄ±nÄ± kaldÄ±r
            const emptyMessage = tableBody.parentElement.querySelector('.text-center.text-muted');
            if (emptyMessage) {
                emptyMessage.remove();
            }
        }

        function updateAlertInTable(alertUpdate) {
            const alertId = alertUpdate.id || alertUpdate.Id;
            const row = document.querySelector(`tr[data-alert-id="${alertId}"]`);
            if (!row) {
                console.log(`Alert ${alertId} tabloda bulunamadÄ±, sayfa yenileniyor...`);
                setTimeout(() => location.reload(), 500);
                return;
            }
            
            if (alertUpdate.isResolved || alertUpdate.IsResolved) {
                // Durum sÃ¼tununu gÃ¼ncelle (8. sÃ¼tun)
                const statusCell = row.querySelector('td:nth-child(8)');
                if (statusCell) {
                    statusCell.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle"></i> Ã‡Ã¶zÃ¼ldÃ¼</span>';
                }
                // Ä°ÅŸlemler sÃ¼tununu gÃ¼ncelle (9. sÃ¼tun)
                const actionCell = row.querySelector('td:nth-child(9)');
                if (actionCell) {
                    actionCell.innerHTML = `
                        <div class="btn-group btn-group-sm" role="group">
                            <button class="btn btn-danger" onclick="deleteAlert(${alertId})" title="UyarÄ±yÄ± Sil">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                }
                // Row'dan table-warning class'Ä±nÄ± kaldÄ±r
                row.classList.remove('table-warning');
            }
            if (alertUpdate.isRead || alertUpdate.IsRead) {
                row.classList.add('table-secondary');
            }
            
            if (typeof updateUnresolvedCount === 'function') {
                updateUnresolvedCount();
            }
        }

        function updateUnresolvedCount() {
            const unresolvedRows = document.querySelectorAll('#alertsTable tbody tr:not([style*="display: none"]) .badge.bg-warning').length;
            const countBadge = document.querySelector('.unresolved-count');
            if (countBadge) {
                countBadge.textContent = `${unresolvedRows} AÃ§Ä±k UyarÄ±`;
            }
        }

        // Alert tablosunu yenile (sayfa yenilemeden) - artÄ±k kullanÄ±lmÄ±yor, addAlertToTable yeterli
        function refreshAlertsTable() {
            // Bu fonksiyon artÄ±k gerekli deÄŸil, addAlertToTable zaten yeni alert'i ekliyor
            console.log("refreshAlertsTable Ã§aÄŸrÄ±ldÄ± - addAlertToTable zaten alert'i ekliyor");
        }
    </script>
}









