@using System.Linq
@model AygazSmartEnergy.Models.EnergyAnalysisViewModel
@{
    ViewData["Title"] = "Enerji Analizi";
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2 class="mb-0"><i class="fas fa-chart-area me-2"></i>@Model.Device.DeviceName Enerji Analizi</h2>
            <small class="text-muted">@Model.AnalysisPeriod g√ºnl√ºk deƒüerlendirme</small>
        </div>
        <a asp-controller="Dashboard" asp-action="Devices" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Cihaz listesine d√∂n
        </a>
    </div>

    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Toplam Enerji</h6>
                    <div class="display-6 fw-bold">
                        @Model.Summary.TotalEnergyUsed.ToString("F2") <small class="text-muted fs-6">kWh</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Ortalama G√ºnl√ºk</h6>
                    <div class="display-6 fw-bold">
                        @Model.Summary.AverageDailyConsumption.ToString("F2") <small class="text-muted fs-6">kWh</small>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Tahmini Fatura</h6>
                    <div class="display-6 fw-bold">
                        @Model.EstimatedMonthlyBill.ToString("C2")
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-body">
                    <h6 class="text-muted text-uppercase">Karbon Ayak ƒ∞zi</h6>
                    <div class="display-6 fw-bold">
                        @Model.CarbonFootprint.ToString("F2") <small class="text-muted fs-6">kg CO‚ÇÇ</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-3">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white">
                    <i class="fas fa-chart-line me-2 text-primary"></i>T√ºketim Trendleri
                </div>
                <div class="card-body">
                    @if (Model.Trends.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-striped align-middle">
                                <thead>
                                    <tr>
                                        <th>Tarih</th>
                                        <th>Enerji (kWh)</th>
                                        <th>Maliyet (‚Ç∫)</th>
                                        <th>Karbon (kg CO‚ÇÇ)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var trend in Model.Trends.OrderByDescending(t => t.Date))
                                    {
                                        <tr>
                                            <td>@trend.Date.ToString("d")</td>
                                            <td>@trend.EnergyUsed.ToString("F2")</td>
                                            <td>@trend.Cost.ToString("F2")</td>
                                            <td>@trend.CarbonFootprint.ToString("F3")</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-chart-line fa-2x mb-2"></i>
                            <p>Hen√ºz analiz edilecek enerji trendi bulunmuyor.</p>
                        </div>
                    }
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <i class="fas fa-search me-2 text-danger"></i>Anomali Kayƒ±tlarƒ±
                </div>
                <div class="card-body">
                    @if (Model.Anomalies.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var anomaly in Model.Anomalies.OrderByDescending(a => a.DetectedAt))
                            {
                                var severityPercent = anomaly.Severity * 100;
                                var severityBadge = severityPercent >= 80 ? "danger" : severityPercent >= 60 ? "warning" : "info";
                                var severityText = severityPercent >= 80 ? "Kritik" : severityPercent >= 60 ? "Y√ºksek" : "Orta";
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <strong class="d-block mb-1">
                                                <i class="fas fa-exclamation-triangle text-@severityBadge me-2"></i>
                                                @anomaly.AnomalyType
                                            </strong>
                                            <p class="mb-1 text-muted small">@anomaly.Description</p>
                                            @if (anomaly.NormalValue > 0 && anomaly.ActualValue > 0)
                                            {
                                                var deviation = ((anomaly.ActualValue - anomaly.NormalValue) / anomaly.NormalValue) * 100;
                                                <div class="small">
                                                    <span class="text-muted">Normal Deƒüer:</span> <strong>@anomaly.NormalValue.ToString("F2")</strong> | 
                                                    <span class="text-muted">Ger√ßek Deƒüer:</span> <strong class="text-@severityBadge">@anomaly.ActualValue.ToString("F2")</strong>
                                                    <span class="badge bg-@severityBadge ms-2">@(deviation > 0 ? "+" : "")@deviation.ToString("F1")% sapma</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(anomaly.Recommendation))
                                            {
                                                <div class="alert alert-light border-start border-3 border-@severityBadge mt-2 mb-0 py-2 small">
                                                    <i class="fas fa-lightbulb text-warning me-2"></i>
                                                    <strong>√ñneri:</strong> @anomaly.Recommendation
                                                </div>
                                            }
                                        </div>
                                        <span class="badge bg-@severityBadge ms-2">@severityText<br>@severityPercent.ToString("F0")%</span>
                                    </div>
                                    <small class="text-muted">
                                        <i class="fas fa-clock me-1"></i>@anomaly.DetectedAt.ToString("dd.MM.yyyy HH:mm:ss")
                                    </small>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-shield-alt fa-2x mb-2"></i>
                            <p>Son d√∂nemde herhangi bir anormallik tespit edilmedi.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-3">
                <div class="card-header bg-white">
                    <i class="fas fa-tachometer-alt me-2 text-success"></i>Verimlilik Raporu
                </div>
                <div class="card-body">
                    @{
                        var avgEfficiency = Model.EfficiencyReport.AverageEfficiency;
                        var efficiencyColor = avgEfficiency >= 90 ? "success" : avgEfficiency >= 80 ? "info" : avgEfficiency >= 70 ? "warning" : "danger";
                        var efficiencyIcon = avgEfficiency >= 90 ? "fa-check-circle" : avgEfficiency >= 80 ? "fa-info-circle" : avgEfficiency >= 70 ? "fa-exclamation-circle" : "fa-times-circle";
                    }
                    <div class="text-center mb-3">
                        <div class="display-4 fw-bold text-@efficiencyColor">
                            @avgEfficiency.ToString("F1")<small class="fs-6">%</small>
                        </div>
                        <span class="badge bg-@efficiencyColor px-3 py-2 mt-2">
                            <i class="fas @efficiencyIcon me-2"></i>
                            @(string.IsNullOrWhiteSpace(Model.EfficiencyReport.EfficiencyGrade) ? "Belirlenmedi" : Model.EfficiencyReport.EfficiencyGrade)
                        </span>
                    </div>
                    <div class="progress mb-3" style="height: 12px;">
                        <div class="progress-bar bg-@efficiencyColor" role="progressbar" 
                             style="width: @(avgEfficiency)%" 
                             aria-valuenow="@avgEfficiency" 
                             aria-valuenow="0" 
                             aria-valuemax="100"></div>
                    </div>
                    <dl class="row mb-0 small">
                        <dt class="col-sm-6">Ortalama Verimlilik</dt>
                        <dd class="col-sm-6 text-end">
                            <strong>@Model.EfficiencyReport.AverageEfficiency.ToString("F1")%</strong>
                            <br><small class="text-muted">Hedef: 85%+</small>
                        </dd>

                        <dt class="col-sm-6">En ƒ∞yi Performans</dt>
                        <dd class="col-sm-6 text-end">
                            <strong class="text-success">@Model.EfficiencyReport.PeakEfficiency.ToString("F1")%</strong>
                        </dd>

                        <dt class="col-sm-6">En D√º≈ü√ºk Performans</dt>
                        <dd class="col-sm-6 text-end">
                            <strong class="text-danger">@Model.EfficiencyReport.LowEfficiency.ToString("F1")%</strong>
                        </dd>
                    </dl>
                    <div class="alert alert-light border-start border-3 border-@efficiencyColor mt-3 mb-0 small">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Yorum:</strong> 
                        @if (avgEfficiency >= 90) {
                            <text>M√ºkemmel verimlilik seviyesi. Cihaz optimal √ßalƒ±≈üƒ±yor.</text>
                        } else if (avgEfficiency >= 80) {
                            <text>ƒ∞yi verimlilik seviyesi. K√º√ß√ºk iyile≈ütirmeler yapƒ±labilir.</text>
                        } else if (avgEfficiency >= 70) {
                            <text>Orta verimlilik seviyesi. ƒ∞yile≈ütirme √∂nerileri uygulanmalƒ±.</text>
                        } else {
                            <text>D√º≈ü√ºk verimlilik seviyesi. Acil iyile≈ütirme gerekli.</text>
                        }
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm">
                <div class="card-header bg-white">
                    <i class="fas fa-lightbulb me-2 text-warning"></i>Tasarruf √ñnerileri
                </div>
                <div class="card-body">
                    @if (Model.Recommendations.Actions.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var action in Model.Recommendations.Actions)
                            {
                                var priorityColor = action.Priority == "High" ? "danger" : action.Priority == "Medium" ? "warning" : "info";
                                var priorityIcon = action.Priority == "High" ? "fa-exclamation-circle" : action.Priority == "Medium" ? "fa-info-circle" : "fa-check-circle";
                                var roi = action.ImplementationCost > 0 ? (action.PotentialSavings * 12 / action.ImplementationCost * 100) : 0;
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <strong class="d-block mb-1">
                                                <i class="fas @priorityIcon text-@priorityColor me-2"></i>
                                                @action.ActionName
                                            </strong>
                                            <p class="mb-2 text-muted small">@action.Description</p>
                                            
                                            @if (action.Steps != null && action.Steps.Any())
                                            {
                                                <div class="small mb-2">
                                                    <strong class="text-muted">Uygulama Adƒ±mlarƒ±:</strong>
                                                    <ol class="mb-0 mt-1 small">
                                                        @foreach (var step in action.Steps)
                                                        {
                                                            <li>@step</li>
                                                        }
                                                    </ol>
                                                </div>
                                            }
                                        </div>
                                        <span class="badge bg-@priorityColor ms-2">@action.Priority</span>
                                    </div>
                                    <div class="row g-2 small">
                                        <div class="col-6">
                                            <strong class="text-success d-block">üí∞ Potansiyel Tasarruf</strong>
                                            <span class="text-success">@action.PotentialSavings.ToString("C2")/ay</span>
                                        </div>
                                        <div class="col-6">
                                            <strong class="text-info d-block">‚ö° Enerji Azaltma</strong>
                                            <span class="text-info">@action.EnergyReduction.ToString("F1") kWh/ay</span>
                                        </div>
                                        <div class="col-6">
                                            <strong class="text-muted d-block">üíµ Uygulama Maliyeti</strong>
                                            <span>@action.ImplementationCost.ToString("C2")</span>
                                        </div>
                                        <div class="col-6">
                                            <strong class="text-muted d-block">‚è±Ô∏è Geri √ñdeme</strong>
                                            <span>@action.PaybackPeriod ay</span>
                                        </div>
                                        @if (roi > 0)
                                        {
                                            <div class="col-12 mt-2">
                                                <div class="alert alert-light border-start border-3 border-success mb-0 py-2">
                                                    <strong class="text-success">üìà Yƒ±llƒ±k Getiri (ROI):</strong> 
                                                    <span class="text-success fw-bold">@roi.ToString("F1")%</span>
                                                    @if (roi > 100) {
                                                        <br><small class="text-success">‚úÖ Yatƒ±rƒ±m 1 yƒ±lda kendini amorti eder</small>
                                                    } else if (roi > 50) {
                                                        <br><small class="text-info">‚ÑπÔ∏è ƒ∞yi yatƒ±rƒ±m, 2 yƒ±lda geri d√∂n√º≈ü</small>
                                                    } else {
                                                        <br><small class="text-warning">‚ö†Ô∏è Uzun vadeli yatƒ±rƒ±m</small>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="text-center text-muted">
                            <i class="fas fa-lightbulb fa-2x mb-2"></i>
                            <p>ƒ∞yile≈ütirme √∂nerisi bulunmuyor. Enerji veriniz arttƒ±k√ßa √∂neriler burada g√∂r√ºnecek.</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

