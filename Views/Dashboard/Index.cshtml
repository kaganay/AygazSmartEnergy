@using System.Globalization
@using System.Linq
@model AygazSmartEnergy.Models.DashboardViewModel
@{
    ViewData["Title"] = "Dashboard";
    var defaultDeviceId = Model.Devices.FirstOrDefault()?.Id;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <div>
            <h2 class="mb-1">Dashboard</h2>
            <p class="text-muted mb-0">Enerji yÃ¶netim ve izleme</p>
        </div>
        <div class="d-flex align-items-center gap-3">
            <small class="text-muted">Son gÃ¼ncelleme: <span id="lastUpdateTime">@DateTime.Now.ToString("HH:mm:ss")</span></small>
            <span class="badge bg-success" id="connectionStatus">
                <i class="fas fa-circle" style="font-size: 8px;"></i> BaÄŸlÄ±
            </span>
        </div>
    </div>

    <!-- Ã–zet Ä°statistikler -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small mb-1">Toplam Cihaz</div>
                    <h3 class="mb-0">@Model.TotalDevices</h3>
                    <small class="text-muted">@Model.ActiveDevices aktif</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small mb-1">24 Saat Enerji</div>
                    <h3 class="mb-0">@Model.TotalEnergyConsumed.ToString("F1") <small class="fs-6 fw-normal">kWh</small></h3>
                    <small class="text-muted">Son 24 saat</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small mb-1">Toplam Maliyet</div>
                    <h3 class="mb-0">@Model.TotalCost.ToString("C2")</h3>
                    <small class="text-muted">Son 24 saat</small>
                </div>
            </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
            <div class="card">
                <div class="card-body">
                    <div class="text-muted small mb-1">Karbon Ayak Ä°zi</div>
                    <h3 class="mb-0">@Model.TotalCarbonFootprint.ToString("F2") <small class="fs-6 fw-normal">kg</small></h3>
                    <small class="text-muted">COâ‚‚ eÅŸdeÄŸeri</small>
                </div>
            </div>
        </div>
    </div>

    <!-- CanlÄ± SensÃ¶r Verileri -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-header bg-primary text-white">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-wave-square me-2"></i>CanlÄ± SensÃ¶r Verileri
                </h5>
                <small id="lastSensorUpdate" class="text-white-50">Son gÃ¼ncelleme: Bekleniyor...</small>
            </div>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <!-- Cihaz Bilgisi KartÄ± -->
                <div class="col-12 col-md-4">
                    <div class="card border-primary h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-microchip fa-2x text-primary"></i>
                            </div>
                            <div class="text-muted small mb-2">Cihaz AdÄ±</div>
                            <h5 class="mb-2 fw-bold" id="liveDeviceName">
                                <span class="text-muted">Veri bekleniyor...</span>
                            </h5>
                            <div class="text-muted small mb-2">SensÃ¶r AdÄ±</div>
                            <h6 class="mb-2" id="liveSensorName">
                                <span class="text-muted">-</span>
                            </h6>
                            <span class="badge bg-success" id="liveDeviceStatus">
                                <i class="fas fa-circle me-1" style="font-size: 6px;"></i>Online
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- SÄ±caklÄ±k KartÄ± -->
                <div class="col-12 col-md-4">
                    <div class="card border-danger h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-thermometer-half fa-2x text-danger"></i>
                            </div>
                            <div class="text-muted small mb-2">AnlÄ±k SÄ±caklÄ±k</div>
                            <h2 class="mb-1 fw-bold">
                                <span id="liveTemperature" class="text-danger">-</span>
                                <small class="fs-6 text-muted">Â°C</small>
                            </h2>
                            <small class="text-muted d-block" id="liveTemperatureTime">-</small>
                            <div class="mt-2">
                                <span class="badge bg-info" id="liveTemperatureStatus">Normal</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Voltaj KartÄ± -->
                <div class="col-12 col-md-4">
                    <div class="card border-warning h-100">
                        <div class="card-body text-center">
                            <div class="mb-2">
                                <i class="fas fa-bolt fa-2x text-warning"></i>
                            </div>
                            <div class="text-muted small mb-2">AnlÄ±k Voltaj</div>
                            <h2 class="mb-1 fw-bold">
                                <span id="liveVoltage" class="text-warning">-</span>
                                <small class="fs-6 text-muted">V</small>
                            </h2>
                            <small class="text-muted d-block" id="liveVoltageTime">-</small>
                            <div class="mt-2">
                                <span class="badge bg-info" id="liveVoltageStatus">Normal</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Ek Bilgiler -->
            <div class="row g-3 mt-2">
                <div class="col-12 col-md-3">
                    <div class="text-center p-2 bg-light rounded">
                        <div class="text-muted small">AkÄ±m</div>
                        <div class="fw-semibold">
                            <span id="liveCurrent">-</span> <small class="text-muted">A</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="text-center p-2 bg-light rounded">
                        <div class="text-muted small">GÃ¼Ã§ FaktÃ¶rÃ¼</div>
                        <div class="fw-semibold">
                            <span id="livePowerFactor">-</span>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="text-center p-2 bg-light rounded">
                        <div class="text-muted small">Enerji KullanÄ±mÄ±</div>
                        <div class="fw-semibold">
                            <span id="liveEnergyUsage">-</span> <small class="text-muted">W</small>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-md-3">
                    <div class="text-center p-2 bg-light rounded">
                        <div class="text-muted small">Konum</div>
                        <div class="fw-semibold small">
                            <span id="liveLocation">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- UyarÄ±lar ve Grafikler -->
    <div class="row g-3 mb-4">
        <div class="col-12 col-lg-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Son UyarÄ±lar</h5>
                    <a asp-controller="Dashboard" asp-action="Alerts" class="btn btn-sm btn-outline-primary">TÃ¼mÃ¼</a>
                </div>
                <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                    @if (Model.RecentAlerts != null && Model.RecentAlerts.Any())
                    {
                        <div class="list-group list-group-flush">
                            @foreach (var alert in Model.RecentAlerts)
                            {
                                <div class="list-group-item border-0 border-bottom" data-alert-id="@alert.Id">
                                    <div class="d-flex justify-content-between mb-1">
                                        <h6 class="mb-0">@alert.Title</h6>
                                        <span class="badge @(alert.Severity switch {
                                            "Critical" => "bg-danger",
                                            "High" => "bg-warning",
                                            "Medium" => "bg-info",
                                            "Low" => "bg-secondary",
                                            _ => "bg-secondary"
                                        })">
                                            @alert.Severity
                                        </span>
                                    </div>
                                    <p class="small text-muted mb-1">@alert.Message</p>
                                    @{
                                        var tz = TimeZoneInfo.FindSystemTimeZoneById("Europe/Istanbul");
                                        var alertUtc = DateTime.SpecifyKind(alert.CreatedAt, DateTimeKind.Utc);
                                        var alertTr = TimeZoneInfo.ConvertTimeFromUtc(alertUtc, tz);
                                    }
                                    <small class="text-muted">@alertTr.ToString("dd.MM.yyyy HH:mm")</small>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="text-center text-muted p-5">
                            <i class="fas fa-check-circle fa-2x mb-2 d-block"></i>
                            UyarÄ± yok
                        </div>
                    }
                </div>
            </div>
        </div>
        <div class="col-12 col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Enerji TÃ¼ketim GrafiÄŸi</h5>
                </div>
                <div class="card-body">
                    <canvas id="energyChart" height="80"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Cihaz Listesi -->
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Cihazlar</h5>
            <a asp-controller="Dashboard" asp-action="Devices" class="btn btn-sm btn-primary">YÃ¶net</a>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="deviceTable">
                    <thead class="table-light">
                        <tr>
                            <th>Cihaz AdÄ±</th>
                            <th>Konum</th>
                            <th>Son TÃ¼ketim</th>
                            <th>Durum</th>
                            <th>GÃ¼ncelleme</th>
                            <th class="text-end">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model.Devices != null && Model.Devices.Any())
                        {
                            @foreach (var device in Model.Devices)
                            {
                                <tr data-device-id="@device.Id">
                                    <td>
                                        <div class="fw-semibold">@device.DeviceName</div>
                                        <small class="text-muted">@device.DeviceType</small>
                                    </td>
                                    <td>@device.Location</td>
                                    <td class="device-consumption">
                                        @(device.EnergyConsumptions.FirstOrDefault()?.EnergyUsed.ToString("F2") ?? "N/A") kWh
                                    </td>
                                    <td>
                                        <span class="badge device-status-badge @(device.IsActive ? "bg-success" : "bg-secondary")">
                                            @(device.IsActive ? "Aktif" : "Pasif")
                                        </span>
                                    </td>
                                    <td class="device-update-time">
                                        <small class="text-muted">
                                            @{
                                                var rec = device.EnergyConsumptions.FirstOrDefault()?.RecordedAt;
                                                if (rec != null)
                                                {
                                                    var tz = TimeZoneInfo.FindSystemTimeZoneById("Europe/Istanbul");
                                                    var recUtc = DateTime.SpecifyKind(rec.Value, DateTimeKind.Utc);
                                                    var recTr = TimeZoneInfo.ConvertTimeFromUtc(recUtc, tz);
                                                    @recTr.ToString("dd.MM.yyyy HH:mm");
                                                }
                                                else
                                                {
                                                    @Html.Raw("-");
                                                }
                                            }
                                        </small>
                                    </td>
                                    <td class="text-end">
                                        <a asp-controller="Dashboard" asp-action="DeviceDetails" asp-route-id="@device.Id" 
                                           class="btn btn-sm btn-outline-primary">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    HenÃ¼z cihaz eklenmemiÅŸ
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        // Enerji tÃ¼ketim grafiÄŸi
        const energyCtx = document.getElementById('energyChart').getContext('2d');
        const energyChart = new Chart(energyCtx, {
            type: 'line',
            data: {
                labels: ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00', '24:00'],
                datasets: [{
                    label: 'Enerji TÃ¼ketimi (kWh)',
                    data: [12, 19, 3, 5, 2, 3, 8],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                },
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

        // ðŸ”¹ DOM ReferanslarÄ±: GÃ¼ncellenecek elementler
        const temperatureEl = document.getElementById('liveTemperature');
        const voltageEl = document.getElementById('liveVoltage');
        const deviceNameEl = document.getElementById('liveDeviceName');
        const sensorNameEl = document.getElementById('liveSensorName');
        const deviceStatusEl = document.getElementById('liveDeviceStatus');
        const lastUpdateTimeEl = document.getElementById('lastUpdateTime');
        const lastSensorUpdateEl = document.getElementById('lastSensorUpdate');
        const currentEl = document.getElementById('liveCurrent');
        const powerFactorEl = document.getElementById('livePowerFactor');
        const energyUsageEl = document.getElementById('liveEnergyUsage');
        const locationEl = document.getElementById('liveLocation');
        const temperatureTimeEl = document.getElementById('liveTemperatureTime');
        const voltageTimeEl = document.getElementById('liveVoltageTime');
        const temperatureStatusEl = document.getElementById('liveTemperatureStatus');
        const voltageStatusEl = document.getElementById('liveVoltageStatus');
        
        // ðŸ”¹ Son GÃ¼ncelleme ZamanÄ±: Her saniye gÃ¼ncelle
        setInterval(() => {
            if (lastUpdateTimeEl) {
                const now = new Date();
                lastUpdateTimeEl.textContent = now.toLocaleTimeString('tr-TR');
            }
        }, 1000);

        // ðŸ”¹ SignalR BaÄŸlantÄ±sÄ±: GerÃ§ek zamanlÄ± veri iÃ§in
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/energyHub")
            .build();

        // ðŸ”¹ SensÃ¶r Verisi GÃ¼ncellemesi: Yeni sensÃ¶r verisi geldiÄŸinde
        connection.on("ReceiveSensorData", (sensorData) => {
            if (!sensorData) return;
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString('tr-TR');
            
            // ðŸ”¹ SÄ±caklÄ±k GÃ¼ncelleme
            if (sensorData.temperature && sensorData.temperature > 0 && temperatureEl) {
                temperatureEl.textContent = sensorData.temperature.toFixed(1);
                if (temperatureTimeEl) {
                    temperatureTimeEl.textContent = timeStr;
                }
                // SÄ±caklÄ±k durumu (Normal: <40Â°C, YÃ¼ksek: 40-50Â°C, Kritik: >50Â°C)
                if (temperatureStatusEl) {
                    if (sensorData.temperature > 50) {
                        temperatureStatusEl.textContent = 'Kritik';
                        temperatureStatusEl.className = 'badge bg-danger';
                    } else if (sensorData.temperature > 40) {
                        temperatureStatusEl.textContent = 'YÃ¼ksek';
                        temperatureStatusEl.className = 'badge bg-warning';
                    } else {
                        temperatureStatusEl.textContent = 'Normal';
                        temperatureStatusEl.className = 'badge bg-success';
                    }
                }
            }
            
            // ðŸ”¹ Voltaj GÃ¼ncelleme
            if (sensorData.voltage && sensorData.voltage > 0 && voltageEl) {
                voltageEl.textContent = sensorData.voltage.toFixed(2);
                if (voltageTimeEl) {
                    voltageTimeEl.textContent = timeStr;
                }
                // Voltaj durumu (Normal: 200-250V, DÃ¼ÅŸÃ¼k: <200V, YÃ¼ksek: >250V)
                if (voltageStatusEl) {
                    if (sensorData.voltage < 200 || sensorData.voltage > 250) {
                        voltageStatusEl.textContent = 'Anormal';
                        voltageStatusEl.className = 'badge bg-danger';
                    } else {
                        voltageStatusEl.textContent = 'Normal';
                        voltageStatusEl.className = 'badge bg-success';
                    }
                }
            }
            
            // ðŸ”¹ Cihaz AdÄ± ve SensÃ¶r AdÄ± GÃ¼ncelleme
            const sensorName = sensorData.sensorName || sensorData.SensorName;
            
            if (sensorData.deviceId || sensorData.DeviceId) {
                // DeviceId varsa cihaz adÄ±nÄ± API'den al
                const deviceId = sensorData.deviceId || sensorData.DeviceId;
                
                // Cihaz adÄ±nÄ± API'den al (cache'lenebilir)
                fetch(`/api/IoT/devices`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.data) {
                            const device = data.data.find(d => (d.id === deviceId) || (d.Id === deviceId));
                            if (device && deviceNameEl) {
                                const deviceName = device.deviceName || device.DeviceName || 'Bilinmeyen Cihaz';
                                deviceNameEl.innerHTML = `<span class="text-primary fw-bold">${deviceName}</span>`;
                                
                                // SensÃ¶r adÄ±nÄ± da gÃ¶ster
                                if (sensorName && sensorNameEl) {
                                    sensorNameEl.innerHTML = `<span class="text-info">${sensorName}</span>`;
                                }
                            }
                        }
                    })
                    .catch(err => {
                        console.error('Cihaz bilgisi alÄ±namadÄ±:', err);
                        // Hata durumunda sadece sensÃ¶r adÄ±nÄ± gÃ¶ster
                        if (sensorName && deviceNameEl) {
                            deviceNameEl.innerHTML = `<span class="text-warning">${sensorName}</span> <small class="text-muted">(Cihaz ID: ${deviceId})</small>`;
                        }
                    });
            } else {
                // DeviceId yoksa sadece sensÃ¶r adÄ±nÄ± gÃ¶ster
                if (sensorName) {
                    if (deviceNameEl) {
                        deviceNameEl.innerHTML = `<span class="text-warning fw-bold">${sensorName}</span> <small class="text-muted">(Cihaz ID yok)</small>`;
                    }
                    if (sensorNameEl) {
                        sensorNameEl.innerHTML = `<span class="text-muted">-</span>`;
                    }
                }
            }
            
            // ðŸ”¹ DiÄŸer Veriler: AkÄ±m, GÃ¼Ã§ FaktÃ¶rÃ¼, Enerji KullanÄ±mÄ±, Konum
            if (sensorData.current !== undefined && sensorData.current !== null && currentEl) {
                currentEl.textContent = sensorData.current.toFixed(2);
            }
            if (sensorData.powerFactor !== undefined && sensorData.powerFactor !== null && powerFactorEl) {
                powerFactorEl.textContent = sensorData.powerFactor.toFixed(2);
            }
            if (sensorData.energyUsage !== undefined && sensorData.energyUsage !== null && energyUsageEl) {
                energyUsageEl.textContent = sensorData.energyUsage.toFixed(2);
            }
            if (sensorData.location || sensorData.Location) {
                const location = sensorData.location || sensorData.Location;
                if (locationEl) {
                    locationEl.textContent = location || '-';
                }
            }
            
            // ðŸ”¹ Cihaz Durumu: Online olarak iÅŸaretle
            if (deviceStatusEl) {
                deviceStatusEl.innerHTML = '<i class="fas fa-circle me-1" style="font-size: 6px;"></i>Online';
                deviceStatusEl.className = 'badge bg-success';
            }
            
            // ðŸ”¹ Son GÃ¼ncelleme ZamanÄ±
            if (lastSensorUpdateEl) {
                lastSensorUpdateEl.textContent = `Son gÃ¼ncelleme: ${timeStr}`;
            }
            
            // ðŸ”¹ Grafik GÃ¼ncelleme
            updateEnergyChart(sensorData);
        });

        connection.on("ReceiveEnergyConsumption", (consumption) => {
            if (!consumption) return;
            updateEnergyChart(consumption);
            updateDeviceTable(consumption);
        });

        connection.on("ReceiveAlert", (alert) => {
            if (!alert) return;
            showAlertNotification(alert);
            addAlertToTable(alert);
        });

        connection.on("ReceiveAlertUpdate", (alertUpdate) => {
            if (!alertUpdate) return;
            updateAlertInTable(alertUpdate);
        });

        connection.on("ReceiveDeviceStatus", (deviceStatus) => {
            if (!deviceStatus) return;
            updateDeviceStatusInTable(deviceStatus);
        });

        connection.start().then(function () {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i> BaÄŸlÄ±';
                statusEl.className = 'badge bg-success';
            }
        }).catch(function (err) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.innerHTML = '<i class="fas fa-circle" style="font-size: 8px;"></i> BaÄŸlantÄ± Yok';
                statusEl.className = 'badge bg-danger';
            }
        });

        function updateEnergyChart(data) {
            if (!energyChart) return;
            const now = new Date();
            const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            const energyValue = data.energyUsed || data.EnergyUsed || 0;
            
            if (energyChart.data.labels.length > 7) {
                energyChart.data.labels.shift();
                energyChart.data.datasets[0].data.shift();
            }
            energyChart.data.labels.push(timeLabel);
            energyChart.data.datasets[0].data.push(energyValue);
            energyChart.update('none');
        }

        function updateDeviceTable(consumption) {
            const deviceId = consumption.deviceId || consumption.DeviceId;
            if (!deviceId) return;
            
            const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
            if (row) {
                const consumptionCell = row.querySelector('.device-consumption');
                if (consumptionCell) {
                    const energy = consumption.energyUsed || consumption.EnergyUsed || 0;
                    consumptionCell.textContent = energy.toFixed(2) + ' kWh';
                }
                const timeCell = row.querySelector('.device-update-time');
                if (timeCell) {
                    const time = consumption.recordedAt || consumption.RecordedAt;
                    timeCell.innerHTML = '<small class="text-muted">' + new Date(time).toLocaleString('tr-TR') + '</small>';
                }
            }
        }

        function showAlertNotification(alert) {
            const severity = alert.severity || alert.Severity || 'Medium';
            const bgColor = severity === 'Critical' ? 'danger' : 
                           severity === 'High' ? 'warning' : 
                           severity === 'Medium' ? 'info' : 'secondary';
            
            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${bgColor} border-0`;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <strong>${alert.title || alert.Title}</strong><br>
                        ${alert.message || alert.Message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;
            
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast, { delay: 5000 });
            bsToast.show();
            toast.addEventListener('hidden.bs.toast', () => toast.remove());
        }

        function addAlertToTable(alert) {
            const alertsList = document.querySelector('.list-group');
            if (!alertsList) {
                console.warn('Alert listesi bulunamadÄ±');
                return;
            }
            
            const severity = alert.severity || alert.Severity || 'Medium';
            const severityClass = severity === 'Critical' ? 'bg-danger' : 
                                 severity === 'High' ? 'bg-warning' : 
                                 severity === 'Medium' ? 'bg-info' : 'bg-secondary';
            
            // Tarih formatla
            const createdAt = alert.createdAt || alert.CreatedAt;
            let dateStr = 'Åžimdi';
            if (createdAt) {
                try {
                    const date = new Date(createdAt);
                    dateStr = date.toLocaleString('tr-TR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    console.error('Tarih formatlama hatasÄ±:', e);
                }
            }
            
            const item = document.createElement('div');
            item.className = 'list-group-item border-0 border-bottom';
            item.setAttribute('data-alert-id', alert.id || alert.Id);
            item.innerHTML = `
                <div class="d-flex justify-content-between mb-1">
                    <h6 class="mb-0">${alert.title || alert.Title || 'Yeni UyarÄ±'}</h6>
                    <span class="badge ${severityClass}">${severity}</span>
                </div>
                <p class="small text-muted mb-1">${alert.message || alert.Message || ''}</p>
                <small class="text-muted">${dateStr}</small>
            `;
            
            // En Ã¼ste ekle
            alertsList.insertBefore(item, alertsList.firstChild);
            
            // Maksimum 10 alert gÃ¶ster
            while (alertsList.children.length > 10) {
                alertsList.removeChild(alertsList.lastChild);
            }
            
            console.log('âœ“ Alert dashboard\'a eklendi:', alert.title || alert.Title);
        }

        function updateAlertInTable(alertUpdate) {
            const alertId = alertUpdate.id || alertUpdate.Id;
            const item = document.querySelector(`[data-alert-id="${alertId}"]`);
            if (item && (alertUpdate.isResolved || alertUpdate.IsResolved)) {
                item.style.opacity = '0.6';
            }
        }

        function updateDeviceStatusInTable(deviceStatus) {
            const deviceId = deviceStatus.deviceId || deviceStatus.DeviceId;
            if (!deviceId) return;
            
            const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
            if (row) {
                const statusCell = row.querySelector('.device-status-badge');
                const isActive = deviceStatus.isActive || deviceStatus.IsActive;
                if (statusCell) {
                    statusCell.className = `badge device-status-badge ${isActive ? 'bg-success' : 'bg-secondary'}`;
                    statusCell.textContent = isActive ? 'Aktif' : 'Pasif';
                }
            }
        }

        // Son sensÃ¶r verilerini yÃ¼kle
        fetch('/api/IoT/sensor-data/latest?count=1')
            .then(r => r.json())
            .then(d => {
                if (d && d.success && d.data && d.data.length > 0) {
                    const sensor = d.data[0];
                    if (sensor.temperature && sensor.temperature > 0 && temperatureEl) {
                        temperatureEl.textContent = sensor.temperature.toFixed(1);
                    }
                    if (sensor.voltage && sensor.voltage > 0 && voltageEl) {
                        voltageEl.textContent = sensor.voltage.toFixed(2);
                    }
                }
            }).catch(() => {});
    </script>
}
