@{
    ViewData["Title"] = "Cihazlar";
}

@model List<AygazSmartEnergy.Models.Device>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4 mt-3">
        <div>
            <h2 class="mb-1">Cihaz YÃ¶netimi</h2>
            <p class="text-muted mb-0">TÃ¼m cihazlarÄ± gÃ¶rÃ¼ntÃ¼leyin ve yÃ¶netin</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addDeviceModal">
            <i class="fas fa-plus me-2"></i>Yeni Cihaz
        </button>
    </div>

    <div class="card">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0" id="devicesTable">
                    <thead class="table-light">
                        <tr>
                            <th>Cihaz AdÄ±</th>
                            <th>Tip</th>
                            <th>Konum</th>
                            <th>Durum</th>
                            <th>Kurulum</th>
                            <th class="text-end">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (Model != null && Model.Any())
                        {
                            @foreach (var device in Model)
                            {
                                <tr data-device-id="@device.Id">
                                    <td>
                                        <div class="fw-semibold">@device.DeviceName</div>
                                        @if (!string.IsNullOrEmpty(device.SerialNumber))
                                        {
                                            <small class="text-muted">SN: @device.SerialNumber</small>
                                        }
                                    </td>
                                    <td>@device.DeviceType</td>
                                    <td>@device.Location</td>
                                    <td>
                                        <span class="badge device-status-badge @(device.IsActive ? "bg-success" : "bg-secondary")">
                                            @(device.IsActive ? "Aktif" : "Pasif")
                                        </span>
                                    </td>
                                    <td>
                                        <small class="text-muted">@device.InstalledAt.ToString("dd.MM.yyyy")</small>
                                    </td>
                                    <td class="text-end">
                                        <div class="btn-group btn-group-sm">
                                            <a asp-controller="Dashboard" asp-action="DeviceDetails" asp-route-id="@device.Id" 
                                               class="btn btn-outline-primary" title="Detaylar">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a asp-controller="Dashboard"
                                               asp-action="EnergyForecast"
                                               asp-route-deviceId="@device.Id"
                                               asp-route-daysAhead="7"
                                               class="btn btn-outline-success"
                                               title="AI Enerji Tahmini (7 GÃ¼n)">
                                                <i class="fas fa-chart-line"></i>
                                            </a>
                                            <button type="button" class="btn btn-outline-warning" 
                                                    data-bs-toggle="modal" data-bs-target="#editDeviceModal" 
                                                    data-device-id="@device.Id"
                                                    data-device-name="@device.DeviceName"
                                                    data-device-type="@device.DeviceType"
                                                    data-device-location="@device.Location"
                                                    title="DÃ¼zenle">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-outline-danger" 
                                                    onclick="confirmDeleteDevice(@device.Id, '@device.DeviceName')"
                                                    title="Sil">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                        else
                        {
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-2x mb-3 d-block"></i>
                                    HenÃ¼z cihaz eklenmemiÅŸ
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Yeni Cihaz Ekleme Modal -->
<div class="modal fade" id="addDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Yeni Cihaz Ekle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addDeviceForm">
                <div class="modal-body">
                    <div id="deviceFormErrors" class="alert alert-danger d-none"></div>
                    
                    <div class="mb-3">
                        <label class="form-label">Cihaz AdÄ± <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="deviceName" name="deviceName" required placeholder="Cihaz adÄ±nÄ± girin">
                    </div>

                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Otomatik Anomali Tespiti:</strong> Cihaz eklendikten sonra, dÄ±ÅŸardan gÃ¶nderilen sensÃ¶r verileri (voltaj, akÄ±m, sÄ±caklÄ±k, vb.) otomatik olarak Python ML servisi tarafÄ±ndan analiz edilecek ve olasÄ± hata/arÄ±za durumlarÄ± tespit edilerek uyarÄ± oluÅŸturulacaktÄ±r.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="submit" class="btn btn-primary" id="submitDeviceBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        Ekle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- DÃ¼zenleme Modal -->
<div class="modal fade" id="editDeviceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Cihaz DÃ¼zenle</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editDeviceForm">
                <div class="modal-body">
                    <div id="editDeviceFormErrors" class="alert alert-danger d-none"></div>
                    <input type="hidden" id="editDeviceId" name="deviceId">
                    
                    <div class="mb-3">
                        <label class="form-label">Cihaz AdÄ± <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="editDeviceName" name="deviceName" required placeholder="Cihaz adÄ±nÄ± girin">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Cihaz Tipi</label>
                        <input type="text" class="form-control" id="editDeviceType" name="deviceType" placeholder="Cihaz tipini girin">
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Konum</label>
                        <input type="text" class="form-control" id="editDeviceLocation" name="location" placeholder="Konum bilgisi">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ä°ptal</button>
                    <button type="submit" class="btn btn-warning" id="updateDeviceBtn">
                        <span class="spinner-border spinner-border-sm d-none me-2"></span>
                        GÃ¼ncelle
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/energyHub")
            .build();

        connection.on("ReceiveDeviceStatus", (deviceStatus) => {
            if (!deviceStatus) return;
            const deviceId = deviceStatus.deviceId || deviceStatus.DeviceId;
            const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
            if (row) {
                const statusCell = row.querySelector('.device-status-badge');
                const isActive = deviceStatus.isActive || deviceStatus.IsActive;
                if (statusCell) {
                    statusCell.className = `badge ${isActive ? 'bg-success' : 'bg-secondary'}`;
                    statusCell.textContent = isActive ? 'Aktif' : 'Pasif';
                }
            }
        });

        connection.start().catch(err => console.error("SignalR hatasÄ±:", err));

        document.getElementById('addDeviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('submitDeviceBtn');
            const spinner = submitBtn.querySelector('.spinner-border');
            const errorDiv = document.getElementById('deviceFormErrors');
            
            submitBtn.disabled = true;
            spinner.classList.remove('d-none');
            errorDiv.classList.add('d-none');
            
            const formData = new FormData(this);
            const deviceData = {
                deviceName: formData.get('deviceName'),
                deviceType: "Other",
                location: "Belirtilmedi",
                isActive: true
            };

            fetch('/api/iot/devices', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(deviceData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    errorDiv.textContent = data.message || 'Bir hata oluÅŸtu';
                    errorDiv.classList.remove('d-none');
                }
            })
            .catch(error => {
                errorDiv.textContent = 'BaÄŸlantÄ± hatasÄ± oluÅŸtu';
                errorDiv.classList.remove('d-none');
            })
            .finally(() => {
                submitBtn.disabled = false;
                spinner.classList.add('d-none');
            });
        });

        // ðŸ”¹ DÃ¼zenleme Modal: Cihaz bilgilerini modal'a yÃ¼kle
        const editDeviceModal = document.getElementById('editDeviceModal');
        editDeviceModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const deviceId = button.getAttribute('data-device-id');
            const deviceName = button.getAttribute('data-device-name');
            const deviceType = button.getAttribute('data-device-type');
            const deviceLocation = button.getAttribute('data-device-location');

            document.getElementById('editDeviceId').value = deviceId;
            document.getElementById('editDeviceName').value = deviceName || '';
            document.getElementById('editDeviceType').value = deviceType || '';
            document.getElementById('editDeviceLocation').value = deviceLocation || '';
        });

        // ðŸ”¹ DÃ¼zenleme Formu: Cihaz bilgilerini gÃ¼ncelle
        document.getElementById('editDeviceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const submitBtn = document.getElementById('updateDeviceBtn');
            const spinner = submitBtn.querySelector('.spinner-border');
            const errorDiv = document.getElementById('editDeviceFormErrors');
            
            submitBtn.disabled = true;
            spinner.classList.remove('d-none');
            errorDiv.classList.add('d-none');
            
            const deviceId = document.getElementById('editDeviceId').value;
            const deviceData = {
                deviceName: document.getElementById('editDeviceName').value,
                deviceType: document.getElementById('editDeviceType').value || 'Other',
                location: document.getElementById('editDeviceLocation').value || 'Belirtilmedi'
            };

            fetch(`/Dashboard/UpdateDevice/${deviceId}`, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                },
                body: JSON.stringify(deviceData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    errorDiv.textContent = data.message || 'Bir hata oluÅŸtu';
                    errorDiv.classList.remove('d-none');
                }
            })
            .catch(error => {
                errorDiv.textContent = 'BaÄŸlantÄ± hatasÄ± oluÅŸtu';
                errorDiv.classList.remove('d-none');
            })
            .finally(() => {
                submitBtn.disabled = false;
                spinner.classList.add('d-none');
            });
        });

        // ðŸ”¹ Silme OnayÄ±: CihazÄ± silmek iÃ§in onay iste
        function confirmDeleteDevice(deviceId, deviceName) {
            if (confirm(`"${deviceName}" cihazÄ±nÄ± silmek istediÄŸinize emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz!`)) {
                deleteDevice(deviceId);
            }
        }

        // ðŸ”¹ Silme Ä°ÅŸlemi: CihazÄ± sil
        function deleteDevice(deviceId) {
            fetch(`/Dashboard/DeleteDevice/${deviceId}`, {
                method: 'POST',
                headers: { 
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // SatÄ±rÄ± tablodan kaldÄ±r
                    const row = document.querySelector(`tr[data-device-id="${deviceId}"]`);
                    if (row) {
                        row.remove();
                    }
                    // EÄŸer tablo boÅŸaldÄ±ysa mesaj gÃ¶ster
                    const tbody = document.querySelector('#devicesTable tbody');
                    if (tbody && tbody.children.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="6" class="text-center text-muted py-5">
                                    <i class="fas fa-inbox fa-2x mb-3 d-block"></i>
                                    HenÃ¼z cihaz eklenmemiÅŸ
                                </td>
                            </tr>
                        `;
                    }
                } else {
                    alert(data.message || 'Cihaz silinirken bir hata oluÅŸtu');
                }
            })
            .catch(error => {
                alert('BaÄŸlantÄ± hatasÄ± oluÅŸtu');
            });
        }
    </script>
}
